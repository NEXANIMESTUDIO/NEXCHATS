<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NEX STUDIO - Home</title>

  <!-- Google Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }

    body {
      background-color: #1a1a1a;
      color: #fff;
      overflow-x: hidden;
    }

    /* Top Section with Title and Icons */
    .top-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background-color: #000;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      position: relative;
    }

    .top-section h1 {
      font-size: 24px;
      font-weight: bold;
      color: #00ff00;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    .icons {
      display: flex;
      gap: 20px;
    }

    .icons i {
      font-size: 25px;
      cursor: pointer;
      transition: transform 0.3s ease;
      color: #fff;
    }

    .icons i:hover {
      transform: scale(1.2);
    }

    /* Chat Section */
    .chat-section {
      padding: 20px;
    }

    .chat-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #333;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .chat-option:hover {
      background-color: #444;
    }

    .chat-option h2 {
      font-size: 18px;
    }

    .unread-count {
      background-color: #ff0000;
      padding: 5px 10px;
      border-radius: 20px;
      color: white;
      font-weight: bold;
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.7);
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: #000;
      display: flex;
      justify-content: space-around;
      padding: 15px;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.7);
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .nav-item i {
      font-size: 30px;
      color: #fff;
    }

    .nav-item p {
      font-size: 12px;
      margin-top: 5px;
    }

    .nav-item:hover {
      transform: scale(1.1);
    }

    /* Floating Animation */
    @keyframes float {
      0% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
      100% { transform: translateY(0); }
    }

    .nav-item i {
      animation: float 3s infinite ease-in-out;
    }

  </style>
</head>
<body>

  <!-- Top Section with NEX STUDIO Title, Search and Notification Icons -->
  <div class="top-section">
    <h1>NEX STUDIO</h1>
    <div class="icons">
      <i class="material-icons" id="notificationIcon">notifications</i>
      <i class="material-icons" id="searchIcon">search</i>
    </div>
  </div>

  <!-- Chat Section with Group Chat -->
  <div class="chat-section">
    <div class="chat-option" id="chatHub">
      <h2>Chat Hub</h2>
      <div class="unread-count">3</div> <!-- Unread message counter -->
    </div>
  </div>

  <!-- Bottom Navigation similar to WhatsApp -->
  <div class="bottom-nav">
    <div class="nav-item" id="chatNav">
      <i class="material-icons">chat</i>
      <p>Chat</p>
    </div>
    <div class="nav-item" id="storyNav">
      <i class="material-icons">photo_library</i>
      <p>Story</p>
    </div>
    <div class="nav-item" id="gamesNav">
      <i class="material-icons">sports_esports</i>
      <p>Games</p>
    </div>
    <div class="nav-item" id="profileNav">
      <i class="material-icons">person</i>
      <p>Profile</p>
    </div>
  </div>

  <!-- Script for Navigation and Icons -->
  <script type="module">
    // Navigation Click Handlers
    const notificationIcon = document.getElementById('notificationIcon');
    const searchIcon = document.getElementById('searchIcon');
    const chatHub = document.getElementById('chatHub');
    const chatNav = document.getElementById('chatNav');
    const storyNav = document.getElementById('storyNav');
    const gamesNav = document.getElementById('gamesNav');
    const profileNav = document.getElementById('profileNav');

    // Navigate to Notification Page
    notificationIcon.addEventListener('click', () => {
      window.location.href = 'notification.html';
    });

    // Navigate to Search Page
    searchIcon.addEventListener('click', () => {
      window.location.href = 'search.html';
    });

    // Navigate to Chat Hub Page
    chatHub.addEventListener('click', () => {
      window.location.href = 'chathub.html';
    });

    // Bottom Navigation Click Events
    chatNav.addEventListener('click', () => {
      window.location.href = 'chat.html';
    });

    storyNav.addEventListener('click', () => {
      window.location.href = 'story.html';
    });

    gamesNav.addEventListener('click', () => {
      window.location.href = 'games.html';
    });

    profileNav.addEventListener('click', () => {
      window.location.href = 'profile.html';
    });
    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, onSnapshot, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

    // Firebase configuration (from your project setup)
    const firebaseConfig = {
      apiKey: "AIzaSyA-GWZtFJsLp2lpwXCyMxHiBuwQwmRrf7E",
      authDomain: "nex-chats-80c04.firebaseapp.com",
      databaseURL: "https://nex-chats-80c04-default-rtdb.firebaseio.com",
      projectId: "nex-chats-80c04",
      storageBucket: "nex-chats-80c04.appspot.com",
      messagingSenderId: "141566009337",
      appId: "1:141566009337:web:c63335bd2ef19c7a816728"
    };

    // Initialize Firebase and Firestore
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();
    const provider = new GoogleAuthProvider();

    // HTML elements for chat functionality
    const chatInput = document.getElementById('messageInput'); // Chat message input
    const sendBtn = document.getElementById('sendBtn'); // Send message button
    const chatArea = document.getElementById('chatArea'); // Chat area to display messages

    // Store the current user's data after login
    let currentUser = null;

    // Function to handle Google Sign-In and store user data in Firestore
    function googleSignIn() {
      signInWithPopup(auth, provider)
        .then((result) => {
          currentUser = result.user;
          const usersRef = collection(db, "users");
          
  // Check if the user already exists in Firestore
          getDocs(query(usersRef, where("userId", "==", currentUser.uid)))
            .then((querySnapshot) => {
              if (querySnapshot.empty) {
                // Add user to Firestore if they don't exist
                addDoc(usersRef, {
                  userId: currentUser.uid,
                  username: currentUser.displayName,
                  email: currentUser.email,
                  profilePicture: currentUser.photoURL
                }).then(() => {
                  console.log("User added to Firestore.");
                }).catch((error) => {
                  console.error("Error storing user data:", error);
                });
              } else {
                console.log("User already exists in Firestore.");
              }
            });

          // Redirect to home page or show chat interface
          window.location.href = 'home.html';
        })
        .catch((error) => {
          console.error("Google sign-in failed:", error);
        });
    }

    // Auto-login the user if they are already authenticated
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        loadChats(); // Load chats for the authenticated user
      } else {
        window.location.href = 'login.html'; // Redirect to login if not logged in
      }
    });

    // Function to send chat messages (group or personal)
    sendBtn.addEventListener('click', () => {
      const message = chatInput.value.trim();
      if (message && currentUser) {
        const chatId = "chat_hub"; // Example group chat ID, for personal chats use unique chatId

        // Reference to the messages collection in a specific chat
        const chatMessagesRef = collection(db, "chats", chatId, "messages");

        // Save the message in Firestore
        addDoc(chatMessagesRef, {
          senderId: currentUser.uid,
          text: message,
          timestamp: serverTimestamp()
        }).then(() => {
          chatInput.value = ""; // Clear input after sending
        }).catch((error) => {
          console.error("Error sending message:", error);
        });
      }
    });

    // Function to load chat messages from Firestore (for both group and personal chats)
    function loadChats() {
      const chatId = "chat_hub"; // Example group chat ID, adjust for personal chats
      const chatMessagesRef = collection(db, "chats", chatId, "messages");

      // Query messages in the chat, ordered by timestamp
      const q = query(chatMessagesRef, orderBy("timestamp"));

      // Listen for real-time updates to the chat
      onSnapshot(q, (snapshot) => {
        chatArea.innerHTML = ""; // Clear chat area before loading messages
        snapshot.forEach((doc) => {
          const messageData = doc.data();
          const messageElement = document.createElement('div');
          messageElement.classList.add('message');
          
          // Display message content with sender's ID
          messageElement.innerHTML = `<strong>${messageData.senderId}</strong>: ${messageData.text}`;
          chatArea.appendChild(messageElement);
        });

        // Scroll to the bottom of the chat area
        chatArea.scrollTop = chatArea.scrollHeight;
      });
    }

    // Function to initialize personal chats between users (Optional)
    function createPersonalChat(otherUserId) {
      // Find or create a personal chat between the current user and another user
      const chatsRef = collection(db, "chats");

      // Check if a chat already exists between the two users
      const q = query(chatsRef, where("members", "array-contains", currentUser.uid));
      
      getDocs(q).then((querySnapshot) => {
        let chatId = null;
        querySnapshot.forEach((doc) => {
          const chatData = doc.data();
          if (chatData.members.includes(otherUserId)) {
            chatId = doc.id; // Found existing chat
          }
        });

        if (!chatId) {
          // If no chat exists, create a new one
          addDoc(chatsRef, {
            members: [currentUser.uid, otherUserId],
            type: "personal"
          }).then((docRef) => {
            chatId = docRef.id;
            console.log("New personal chat created:", chatId);
          });
        } else {
          console.log("Existing chat found:", chatId);
        }
      }).catch((error) => {
        console.error("Error finding or creating personal chat:", error);
      });
    }
  </script>

</body>
</html>